<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tunebooks</title>
	<link rel="stylesheet" href="css/pure-min.css" />
	<link rel="stylesheet" href="css/grids-responsive-min.css" />
	<link rel="stylesheet" href="css/buttons-min.css" />
	<link rel="stylesheet" href="css/side-menu.css" />
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="css/dragula.min.css" />
	<link rel="stylesheet" href="css/tom-select.css" />
	<link rel="stylesheet" href="assets/fontawesome/css/fontawesome.min.css" />
	<link rel="stylesheet" href="assets/fontawesome/css/solid.min.css" />
	<script src="lib/jquery-3.7.1.min.js"></script>
	<script src="lib/handlebars.min-v4.7.8.js"></script>
	<script src="lib/handlebars.min-v4.7.8.js"></script>
	<script src="lib/tom-select.complete.min.js"></script>
	<script src='lib/dragula.min.js'></script>
	<script src='lib/abcjs-basic-min.js'></script>
</head>

<body>
	<div id="layout">
		<div id="header">
			<a id="menuLink" class="header-menu"><i class="fa-solid fa-bars"></i></a>
			<p><a id="menuTunes" class="header-item">Tunes</a></p>
			<p><a id="menuSets" class="header-item">Sets</a></p>
		</div>
		<div id="menu">
			<div class="logo">
				<div class="tab-header">
					<p class="tab-title">Tunebooks</p>
				</div>
			</div>
			<div class="menu-footer">
				<button id="tunepal-load-btn" class="pure-button">Load from tunepal</button>
				<button id="save-btn" disabled="true" class="button-secondary pure-button">Save</button>
				<a id="github-link" href="https://github.com/floosh/Tunebooks">Github</a>
			</div>
		</div>
		<div id="main" class="pure-g">
			<div id="tunes" class="pure-u-xl-1-4 pure-u-lg-1-3 pure-u-1">
				<div class="tab-header">
					<select id="tunesBrowse" placeholder="Search a tune..." hidden="true"></select>
				</div>
				<div id="tunes-container">
					<div id="tunes-filter">
						<p onclick="helpers.ui.toggleTuneType('all')">All</p>
						<p onclick="helpers.ui.toggleTuneType('reel')">Reels</p>
						<p onclick="helpers.ui.toggleTuneType(['jig', 'slipjig'])">Jigs</p>
						<p
							onclick="helpers.ui.toggleTuneType(['hornpipe', 'polka', 'slide', 'waltz', 'barndance', 'strathspey', 'three-two', 'mazurka', 'march'])">
							Others</p>
						<p style="float: right" onclick="helpers.ui.toggleLonelyTunes()">Lonely tunes</p>
					</div>
				</div>
			</div>
			<div id="sets" class="pure-u-xl-3-4 pure-u-lg-2-3 pure-u-1">
				<div class="tab-header tab-header-sets">
					<a id="new-set-btn" class="pure-button pure-button-primary" href="#">New set</a>
				</div>
				<div id="sets-container" class=pure-g></div>
			</div>
		</div>
		<div id="popup-container"></div>
	</div>
	<script id="tune-template" type="text/x-handlebars-template">
		<div class="tune-id-{{id}} tune-entry tune-type-{{classify type}} tune-key-{{key}} tune-mode-{{mode}}">
			<p class="tune-json-data" hidden="true">{{json this}}</p>
			<p class="tune-title">{{name}}<i class="fa-solid fa-pen-to-square tune-entry-edit-btn"
				onclick="helpers.tunes.edit(this)"></i><i class="fa-solid fa-music tune-entry-sheet-btn" onclick="helpers.tunes.showTuneSheet(this)"></i></p>
			<p class="tune-info"><span class="tune-type">{{type}}</span><span class="tune-mode">{{key}}{{mode}}</span><span
					class="tune-abc">{{abc}}</span></p>
		</div>
	</script>
	<script id="tune-template-browse" type="text/x-handlebars-template">
		<p class="tune-browse-entry"><span>{{name}}  </span><b><span>({{type}} {{key}}{{mode}})</span></b></p>
	</script>
	<script id="set-template" type="text/x-handlebars-template">
		<div class="set-entry-container pure-u-xl-1-3 pure-u-md-1-2 pure-u-1">
			<div class="set-entry">
				<p class="set-title-bar"><input class="set-title" value="{{title}}"></input><i class="fas fa-xmark set-entry-delete-btn"
					onclick="helpers.sets.delete(this)"></i></p>
				<div class="set-tunes-container">
					{{#each tunes}}
					{{> tune_template}}
					{{/each}}
				</div>
			</div>
		</div>
	</script>
	<script id="tune-entry-popup-template" type="text/x-handlebars-template">
		<div id="popup-background">
			<div id="popup" class="tune-entry-popup">
				<form class="pure-form pure-form-stacked">
					<fieldset>
						<legend class="tune-title">{{name}}</legend>
						<div class="pure-g">
							<div class="pure-control-group pure-form-aligned pure-u-1-2">
								<label>Type</label>
								<select id="tune-entry-popup-type" name="type">
									{{#select type}}
									<option value="jig">jig</option>
									<option value="reel">reel</option>
									<option value="slip jig">slip jig</option>
									<option value="hornpipe">hornpipe</option>
									<option value="polka">polka</option>
									<option value="slide">slide</option>
									<option value="waltz">waltz</option>
									<option value="barndance">barndance</option>
									<option value="strathspey">strathspey</option>
									<option value="three-two">three-two</option>
									<option value="mazurka">mazurka</option>
									<option value="march">march</option>
									{{/select}}
								</select>
							</div>
							<div class="pure-control-group pure-form-aligned pure-u-1-2">
								<label>Key/Mode</label>
								<select id="tune-entry-popup-key" value="{{key}}">
									{{#select key}}
									<option value="A">A</option>
									<option value="B">B</option>
									<option value="C">C</option>
									<option value="D">D</option>
									<option value="E">E</option>
									<option value="F">F</option>
									<option value="G">G</option>
									{{/select}}
								</select>
								<select id="tune-entry-popup-mode" value ="{{mode}}">
									{{#select mode}}
									<option value="maj">maj</option>
									<option value="min">min</option>
									<option value="dor">dor</option>
									<option value="mix">mix</option>
									{{/select}}
								</select>
							</div>
							<div class="pure-control-group pure-u-1">
								<label>ABC</label>
								<textarea id="tune-entry-popup-abc" id="tune-select-mode" rows="5" style="width: 100%;">{{abc}}</textarea>
							</div>
							<br/>
							<div class="pure-control-group pure-u-1" style="margin-top: 10px;">
								<button class="pure-button button-warning" onclick="helpers.popup.actionDelete()">Delete</button>
								<button class="pure-button" style="float: right;" onclick="helpers.popup.close()">Cancel</button>
								<button class="pure-button pure-button-primary" style="float: right; margin-right: 5px;" onclick="helpers.popup.actionSave()">Save</button>
							</div>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</script>
	<script id="tunepal-popup-template" type="text/x-handlebars-template">
		<div id="popup-background">
			<div id="popup" class="tunepal-popup">
				<form class="pure-form pure-form-stacked">
					<fieldset>
						<legend class="tune-title">Load from tunepal</legend>
						<div class="pure-g">
							<p>
								Copy-paste the content of the exported .abc file from tunepal below:
							</p>
							<div class="pure-control-group pure-u-1">
								<textarea id="tune-entry-popup-abc" id="tune-select-mode" rows="20" style="width: 100%;"></textarea>
							</div>
							<br/>
							<div class="pure-control-group pure-u-1" style="margin-top: 10px;">
								<button class="pure-button" style="float: right;" onclick="helpers.popup.close()">Cancel</button>
								<button class="pure-button pure-button-primary" style="float: right; margin-right: 5px;" onclick="parseTunepalABC()">Load</button>
							</div>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</script>
	<script id="tune-sheet-popup-template" type="text/x-handlebars-template">
		<div id="popup-background">
			<div id="popup" class="tune-sheet-popup">
				<div id="tune-sheet-content">
					<div id="tune-sheet"></div>
				</div>
				<div class="pure-control-group pure-u-1" style="margin-top: 10px;">
					<button class="pure-button" style="float: right;" onclick="helpers.popup.close()">Close</button>
				</div>
			</div>
		</div>
	</script>
	<script id="abc-template" type="text/x-handlebars-template">
		T:{{name}}
		R:{{type}}
		K:{{key}}{{mode}}
		{{abc}}
	</script>
	<script>
		var tunes, templates, tune_entry_in_edit_mode;
		var model = { tunes: [], sets: [] };

		var helpers = {
			tunes: {
				add: function (item)
				{
					if (typeof item !== 'object')
					{
						item = helpers.tunes.findById(item);
					}
					if (!item || $("#tunes-container>.tune-entry.tune-id-" + item.id).length > 0)
					{
						// duplicate tune
						return;
					}
					var tunes_container = document.getElementById("tunes-container");
					tunes_container.insertAdjacentHTML('beforeend', templates["tune-template"](item));
					helpers.model.hasChanged();
				},
				delete: function (element)
				{
					var tune_entry = $(element).closest("div.tune-entry");
					tune_entry.remove();
					helpers.model.hasChanged();
				},
				edit: function (element)
				{
					tune_entry_in_edit_mode = $(element).closest("div.tune-entry");
					var tune_to_edit = helpers.tunes.serializeTuneEntry(tune_entry_in_edit_mode);
					helpers.popup.show("tune-entry-popup-template", tune_to_edit);
				},
				serialize: function ()
				{
					var tunes = [];
					$("#tunes-container > div.tune-entry").each(function (id, element)
					{
						tunes.push(helpers.tunes.serializeTuneEntry(element));
					});
					return tunes;
				},
				serializeTuneEntry: function (element)
				{
					return JSON.parse($(element).children("p.tune-json-data")[0].innerText);
				},
				findById(tune_id)
				{
					return tunes[tune_id];
				},
				deserialize: function ()
				{
					if (model.tunes)
					{
						model.tunes.forEach(function (tune)
						{
							helpers.tunes.add(tune);
						});
					}
					helpers.ui.highlightUsedtunes();
				},
				transformMode: function (mode)
				{
					mode = mode.replace("major", "maj");
					mode = mode.replace("minor", "min");
					mode = mode.replace("mixolydian", "mix");
					mode = mode.replace("dorian", "dor");
					return mode;
				},
				showTuneSheet: function(element)
				{
					var tune = helpers.tunes.serializeTuneEntry($(element).closest("div.tune-entry"));
					var abc = templates["abc-template"](tune);
					helpers.popup.show("tune-sheet-popup-template", tune);
					ABCJS.renderAbc("tune-sheet", abc)
				}
			},
			sets: {
				new: function ()
				{
					helpers.sets.add();
				},
				add: function (set)
				{
					if (!set)
					{
						set = {
							title: "Untitled set"
						}
						helpers.model.hasChanged();
					}
					var sets_container = document.getElementById("sets-container");
					sets_container.insertAdjacentHTML('beforeend', templates["set-template"](set));
				},
				delete: function (element)
				{
					var set_entry = $(element).closest("div.set-entry-container");
					set_entry.remove();
					helpers.model.hasChanged();
				},
				serialize: function ()
				{
					var sets = [];
					$("div.set-entry").each(function (id, set_entry)
					{
						var set = {
							title: set_entry.querySelector("input.set-title").value,
							tunes: []
						}
						var tunes = set_entry.querySelectorAll("div.tune-entry").forEach((tune, index) =>
						{
							set.tunes.push(helpers.tunes.serializeTuneEntry(tune));
						});
						sets.push(set);
					});
					return sets;
				},
				deserialize: function ()
				{
					if (model.sets)
					{
						model.sets.forEach(function (set)
						{
							helpers.sets.add(set);
						})
					}
				}
			},
			model: {
				url: "https://api.jsonbin.io/v3/b/64f6f51e8d92e126ae67569e",
				save: function ()
				{
					$("#save-btn")[0].disabled = true;
					model.sets = helpers.sets.serialize();
					model.tunes = helpers.tunes.serialize();
					helpers.json.put(helpers.model.url, model);
				},
				hasChanged: function ()
				{
					$("#save-btn")[0].disabled = false;
					helpers.ui.highlightUsedtunes();
				},
				load: function ()
				{
					helpers.json.get(helpers.model.url + "/latest").then(function (data)
					{
						model = data.record;
						helpers.sets.deserialize();
						helpers.tunes.deserialize();
					});
				},
				loadFromTunepal: function()
				{
					helpers.popup.show("tunepal-popup-template");
				}
			},
			ui: {
				showTunes: function ()
				{
					$("#tunes").css("display", "flex");
				},
				showSets: function ()
				{
					$("#tunes").css("display", "none");
				},
				isMobileView: function ()
				{
					return window.matchMedia("(max-width: 64em)").matches;
				},
				highlightUsedtunes: function ()
				{
					$("#tunes-container>.tune-entry").each((id, tune_entry) =>
					{
						var same_tunes = $('.' + tune_entry.classList[0]);
						same_tunes.removeClass("tune-in-a-set");
						if (same_tunes.length > 1)
						{
							tune_entry.classList.add("tune-in-a-set");
						}
						else
						{
							tune_entry.classList.remove("tune-in-a-set");
						}
					})
				},
				toggleTuneType: function (type)
				{
					if (type === "all")
					{
						$("#tunes-container>.tune-entry").show();
					}
					else
					{
						$("#tunes-container>.tune-entry").hide();
						type = Array.isArray(type) ? type : [type];
						for (var t of type)
						{
							$("#tunes-container>.tune-type-" + t).show();
						}
					}
				},
				toggleLonelyTunes: function ()
				{
					$("#tunes-container>.tune-entry.tune-in-a-set").hide();
				}
			},
			popup: {
				show: function (template_name, context)
				{
					$("#popup-container").html(templates[template_name](context));
				},
				close: function ()
				{
					$("#popup-container").html("");
				},
				actionDelete: function ()
				{
					helpers.popup.close();
					helpers.tunes.delete(tune_entry_in_edit_mode);
				},
				actionSave: function ()
				{
					var tune = helpers.tunes.serializeTuneEntry(tune_entry_in_edit_mode);
					tune.type = $("#tune-entry-popup-type").val();
					tune.key = $("#tune-entry-popup-key").val();
					tune.mode = $("#tune-entry-popup-mode").val();
					tune.abc = $("#tune-entry-popup-abc").val();
					tune_entry_in_edit_mode.replaceWith(templates["tune-template"](tune));
					helpers.popup.close();
				}
			},
			json: {
				get: function (url)
				{
					return new Promise((resolve, reject) =>
					{
						fetch(url).then(response =>
						{
							resolve(response.json());
						});
					});
				},
				put: function (url, data)
				{
					return new Promise((resolve, reject) =>
					{
						fetch(url, {
							method: "PUT",
							mode: "cors",
							cache: "no-cache",
							credentials: "same-origin",
							headers: {
								"Content-Type": "application/json"
							},
							redirect: "follow",
							referrerPolicy: "no-referrer",
							body: JSON.stringify(data),
						}).then(response =>
						{
							resolve(response.json());
						});
					});
				}
			}
		}

		function parseTunepalABC()
		{
			var abc = $("#tune-entry-popup-abc").val();
			var regexp = /I:Tunepal ID:(\d+).*source:thesession.org/gm;
			Array.from(abc.matchAll(regexp), (m) => m[1]).forEach(tune_id => {
				helpers.tunes.add(tune_id);
			});
			helpers.popup.close();
		}

		function initTunesSelect()
		{
			var tunesOptions = Object.values(tunes).map(t =>
			{
				return {
					id: t.id,
					name: t.name,
					type: t.type,
					mode: t.mode,
					key: t.key
				};
			})

			new TomSelect('#tunesBrowse', {
				valueField: 'id',
				labelField: 'name',
				searchField: ['name'],
				options: tunesOptions,
				// custom rendering function for options
				render: {
					option: function (item, escape)
					{
						return templates["tune-template-browse"](item);
					}
				},
				onItemAdd: helpers.tunes.add
			});
		}

		function initDragNDrop()
		{
			var drake = dragula([document.getElementById('tunes-container')], {
				isContainer: function (el)
				{
					return el.classList.contains("set-tunes-container");
				},
				moves: function (el, source, handle, sibling)
				{
					return $(el).hasClass("tune-entry");
				},
				accepts: function (el, target, source, sibling)
				{
					return $(target).hasClass("set-tunes-container")
						|| (source.id === 'tunes-container' && target.id === 'tunes-container');
				},
				copy: function (el, source)
				{
					return source.id === 'tunes-container';
				}
			});
			drake.on("drop", function (el, target, source, sibling)
			{
				if (target)
				{
					helpers.model.hasChanged();
				}
			});
		}

		function initHandlebars()
		{
			templates = ["tune-template", "set-template", "tune-template-browse", "tune-entry-popup-template", "tunepal-popup-template", "tune-sheet-popup-template", "abc-template"]
				.reduce((acc, val, index) =>
				{
					acc[val] = Handlebars.compile(document.getElementById(val).innerHTML)
					return acc;
				}, {});

			Handlebars.registerPartial("tune_template", templates["tune-template"]);
			Handlebars.registerHelper('select', function (value, options)
			{
				var $el = $('<select />').html(options.fn(this));
				$el.find('[value="' + value + '"]').attr({ 'selected': 'selected' });
				return $el.html();
			});
			Handlebars.registerHelper('json', function (context)
			{
				return JSON.stringify(context);
			});
			Handlebars.registerHelper('classify', function (context)
			{
				return context.replace(/\s/g, "");
			});
		}

		initHandlebars();

		var dumpurl = "https://raw.githubusercontent.com/adactio/TheSession-data/master/json/";
		var jsonFiles = ["tunes.json"];
		helpers.json.get(dumpurl + jsonFiles[0])
			.then(function (data)
			{
				tunes = data.reduce((acc, t) =>
				{
					if (!acc[t.tune_id])
					{
						acc[t.tune_id] = {
							id: t.tune_id,
							name: t.name,
							type: t.type,
							key: t.mode[0],
							mode: helpers.tunes.transformMode(t.mode.substring(1)),
							abc: t.abc
						}
					}
					return acc;
				}, {});
				initTunesSelect();
			});

		$(function ()
		{
			helpers.model.load();

			$("#new-set-btn").on("click", helpers.sets.new);
			$("#save-btn").on("click", helpers.model.save);
			$("#tunepal-load-btn").on("click", helpers.model.loadFromTunepal);
			$("#menuTunes").on("click", helpers.ui.showTunes);
			$("#menuSets").on("click", helpers.ui.showSets);

			if (!helpers.ui.isMobileView())
			{
				initDragNDrop();
			}
		});

		$(window).on('resize', function ()
		{
			if (helpers.ui.isMobileView())
			{

			}
			else
			{
				helpers.ui.showTunes();
			}
		});

	</script>
	<script src="lib/ui.js"></script>
</body>

</html>